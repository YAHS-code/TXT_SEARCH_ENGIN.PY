import os
import platform
from word_indexer import creer_index, sauvegarder_index, charger_index
from search_core import rechercher_mot, recherche_multiple, recherche_regex
from stats_analyzer import stats_index, exporter_resultats

# Fonction utilitaire pour nettoyer l'écran (Windows ou Unix)
def clear():
    os.system('cls' if platform.system() == 'Windows' else 'clear')

def afficher_resultats(resultats):
    if not resultats:
        print("\n❌ Aucun résultat trouvé.")
    else:
        print("\n📌 Résultats de recherche :")
        for r in resultats:
            print(f"\u2714 {r['fichier']} - ligne {r['ligne']} - position {r['position']}")
        print(f"\n🧮 Nombre total de résultats : {len(resultats)}")

def afficher_statistiques(stats):
    print("\n📊 STATISTIQUES DU MOTEUR DE RECHERCHE")
    print("=" * 45)
    for cle, valeur in stats.items():
        print(f"\n➡ {cle}:")
        if isinstance(valeur, list):
            for item in valeur:
                print(f"   - {item[0]} : {item[1]}")
        else:
            print(f"   {valeur}")
    print("=" * 45)

def menu():
    clear()
    print("="*60)
    print("             🧠 MOTEUR DE RECHERCHE TXT - CLI")
    print("="*60)

    while True:
        dossier = input("\n📁 Chemin du dossier contenant les .txt : ")
        try:
            print("\n🛠️  Création de l'index en cours...")
            index = creer_index(dossier)
            sauvegarder_index(index)
            print("✅ Index créé et sauvegardé avec succès.")
            break
        except (FileNotFoundError, NotADirectoryError) as e:
            print(f"❗ Erreur : {e}\nVeuillez réessayer.")

    while True:
        print("\n🧭 MENU PRINCIPAL :")
        print("1. 🔍 Rechercher un mot")
        print("2. 🧩 Recherche multiple (OU/ET)")
        print("3. 🔠 Recherche par expression régulière")
        print("4. 📊 Voir les statistiques")
        print("5. 💾 Exporter les résultats")
        print("0. ❌ Quitter")

        choix = input("\nVotre choix : ")
        clear()
        if choix == '1':
            mot = input("Mot à rechercher : ")
            resultats = rechercher_mot(index, mot)
            afficher_resultats(resultats)
        elif choix == '2':
            mots = input("Entrez les mots séparés par un espace : ").split()
            mode = input("Mode (OU / ET) : ").upper()
            resultats = recherche_multiple(index, mots, mode)
            afficher_resultats(resultats)
        elif choix == '3':
            motif = input("Expression régulière : ")
            resultats = recherche_regex(index, motif)
            afficher_resultats(resultats)
        elif choix == '4':
            stats = stats_index(index)
            afficher_statistiques(stats)
        elif choix == '5':
            mots = input("Mot(s) à exporter : ").split()
            mode = input("Mode (OU / ET) : ").upper()
            resultats = recherche_multiple(index, mots, mode)
            exporter_resultats(resultats)
            print("\n✅ Résultats exportés dans resultats.txt")
        elif choix == '0':
            print("\n👋 Merci d'avoir utilisé notre moteur de recherche. À bientôt !")
            break
        else:
            print("\n❗ Choix invalide. Veuillez réessayer.")