import os
import platform
from word_indexer import creer_index, sauvegarder_index, charger_index
from search_core import rechercher_mot, recherche_multiple, recherche_regex
from stats_analyzer import stats_index, exporter_resultats

# Fonction utilitaire pour nettoyer l'Ã©cran (Windows ou Unix)
def clear():
    os.system('cls' if platform.system() == 'Windows' else 'clear')

def afficher_resultats(resultats):
    if not resultats:
        print("\nâŒ Aucun rÃ©sultat trouvÃ©.")
    else:
        print("\nğŸ“Œ RÃ©sultats de recherche :")
        for r in resultats:
            print(f"\u2714 {r['fichier']} - ligne {r['ligne']} - position {r['position']}")
        print(f"\nğŸ§® Nombre total de rÃ©sultats : {len(resultats)}")

def afficher_statistiques(stats):
    print("\nğŸ“Š STATISTIQUES DU MOTEUR DE RECHERCHE")
    print("=" * 45)
    for cle, valeur in stats.items():
        print(f"\nâ¡ {cle}:")
        if isinstance(valeur, list):
            for item in valeur:
                print(f"   - {item[0]} : {item[1]}")
        else:
            print(f"   {valeur}")
    print("=" * 45)

def menu():
    clear()
    print("="*60)
    print("             ğŸ§  MOTEUR DE RECHERCHE TXT - CLI")
    print("="*60)

    while True:
        dossier = input("\nğŸ“ Chemin du dossier contenant les .txt : ")
        try:
            print("\nğŸ› ï¸  CrÃ©ation de l'index en cours...")
            index = creer_index(dossier)
            sauvegarder_index(index)
            print("âœ… Index crÃ©Ã© et sauvegardÃ© avec succÃ¨s.")
            break
        except (FileNotFoundError, NotADirectoryError) as e:
            print(f"â— Erreur : {e}\nVeuillez rÃ©essayer.")

    while True:
        print("\nğŸ§­ MENU PRINCIPAL :")
        print("1. ğŸ” Rechercher un mot")
        print("2. ğŸ§© Recherche multiple (OU/ET)")
        print("3. ğŸ”  Recherche par expression rÃ©guliÃ¨re")
        print("4. ğŸ“Š Voir les statistiques")
        print("5. ğŸ’¾ Exporter les rÃ©sultats")
        print("0. âŒ Quitter")

        choix = input("\nVotre choix : ")
        clear()
        if choix == '1':
            mot = input("Mot Ã  rechercher : ")
            resultats = rechercher_mot(index, mot)
            afficher_resultats(resultats)
        elif choix == '2':
            mots = input("Entrez les mots sÃ©parÃ©s par un espace : ").split()
            mode = input("Mode (OU / ET) : ").upper()
            resultats = recherche_multiple(index, mots, mode)
            afficher_resultats(resultats)
        elif choix == '3':
            motif = input("Expression rÃ©guliÃ¨re : ")
            resultats = recherche_regex(index, motif)
            afficher_resultats(resultats)
        elif choix == '4':
            stats = stats_index(index)
            afficher_statistiques(stats)
        elif choix == '5':
            mots = input("Mot(s) Ã  exporter : ").split()
            mode = input("Mode (OU / ET) : ").upper()
            resultats = recherche_multiple(index, mots, mode)
            exporter_resultats(resultats)
            print("\nâœ… RÃ©sultats exportÃ©s dans resultats.txt")
        elif choix == '0':
            print("\nğŸ‘‹ Merci d'avoir utilisÃ© notre moteur de recherche. Ã€ bientÃ´t !")
            break
        else:
            print("\nâ— Choix invalide. Veuillez rÃ©essayer.")